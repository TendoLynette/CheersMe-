{% extends 'base.html' %}
{% load static %}

{% block title %}{{ event.title }} - CheersMe{% endblock %}


{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/event_detail.css' %}">
{% endblock %}



{% block content %}
<!-- Event Hero -->
<div class="event-hero">
    <img src="{{ event.featured_image.url }}" alt="{{ event.title }}" class="event-hero-image">
    <div class="event-hero-overlay">
        <div class="event-meta-pills">
            <span class="meta-pill">
                <i class="fas fa-tag"></i>
                {{ event.category.get_name_display }}
            </span>
            {% if distance %}
            <span class="meta-pill">
                <i class="fas fa-location-arrow"></i>
                {{ distance }} km away
            </span>
            {% endif %}
            {% if event.is_free %}
            <span class="meta-pill" style="background: var(--lemon-lime);">
                <i class="fas fa-gift"></i>
                FREE
            </span>
            {% endif %}
        </div>
        <h1 class="event-title">{{ event.title }}</h1>
        <div class="event-meta-pills">
            <span class="meta-pill">
                <i class="fas fa-eye"></i>
                {{ event.views }} views
            </span>
            {% if average_rating %}
            <span class="meta-pill">
                <i class="fas fa-star"></i>
                {{ average_rating|floatformat:1 }} ({{ total_reviews }} reviews)
            </span>
            {% endif %}
        </div>
    </div>
</div>

<div class="event-content-grid">
    <!-- Left Column: Event Details -->
    <div>
        <!-- Description -->
        <div class="event-section">
            <h2 class="section-title">About This Event</h2>
            <p style="line-height: 1.8; color: var(--text-secondary);">{{ event.description }}</p>
        </div>
        
        <!-- Event Information -->
        <div class="event-section">
            <h2 class="section-title">Event Details</h2>
            
            <div class="info-item">
                <div class="info-icon">
                    <i class="fas fa-calendar"></i>
                </div>
                <div class="info-content">
                    <h4>Date</h4>
                    <p>{{ event.start_date|date:"l, F d, Y" }}</p>
                </div>
            </div>
            
            <div class="info-item">
                <div class="info-icon">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="info-content">
                    <h4>Time</h4>
                    <p>{{ event.start_time|time:"g:i A" }} - {{ event.end_time|time:"g:i A" }}</p>
                </div>
            </div>
            
            <div class="info-item">
                <div class="info-icon">
                    <i class="fas fa-map-marker-alt"></i>
                </div>
                <div class="info-content">
                    <h4>Venue</h4>
                    <p>{{ event.venue_name }}</p>
                    <p style="font-size: 0.9rem; color: var(--text-secondary);">{{ event.address }}, {{ event.city }}</p>
                </div>
            </div>
            
            <div class="info-item">
                <div class="info-icon">
                    <i class="fas fa-users"></i>
                </div>
                <div class="info-content">
                    <h4>Capacity</h4>
                    <p>{{ event.remaining_capacity }} of {{ event.total_capacity }} spots remaining</p>
                </div>
            </div>
            
            {% if event.has_food or event.has_drinks %}
            <div class="info-item">
                <div class="info-icon">
                    <i class="fas fa-utensils"></i>
                </div>
                <div class="info-content">
                    <h4>Food & Drinks</h4>
                    {% if event.has_food %}
                    <p>üçï {{ event.food_deals }}</p>
                    {% endif %}
                    {% if event.has_drinks %}
                    <p>üçπ {{ event.drink_deals }}</p>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
        
        <!-- Reviews Section -->
        {% if reviews %}
        <div class="event-section">
            <h2 class="section-title">Reviews ({{ total_reviews }})</h2>
            
            {% for review in reviews %}
            <div class="review-card">
                <div class="review-header">
                    <div class="review-avatar">
                        {{ review.user.first_name.0 }}{{ review.user.last_name.0 }}
                    </div>
                    <div>
                        <h4 style="margin: 0; font-weight: 600;">{{ review.user.get_full_name }}</h4>
                        <div class="stars">
                            {% for i in "12345" %}
                                {% if forloop.counter <= review.rating %}
                                    <i class="fas fa-star"></i>
                                {% else %}
                                    <i class="far fa-star"></i>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% if review.comment %}
                <p style="color: var(--text-secondary); margin: 0;">{{ review.comment }}</p>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </div>
    
    <!-- Right Column: Booking -->
    <div>
        <div class="event-section" style="position: sticky; top: 2rem;">
            <h2 class="section-title">Get Tickets</h2>
            
            {% if ticket_types %}
                {% for ticket_type in ticket_types %}
                <div class="ticket-card">
                    <div class="ticket-header">
                        <span class="ticket-name">{{ ticket_type.name }}</span>
                        <span class="ticket-price">
                            {% if event.is_free %}FREE{% else %}UGX {{ ticket_type.price|floatformat:0 }}{% endif %}
                        </span>
                    </div>
                    {% if ticket_type.description %}
                    <p class="ticket-description">{{ ticket_type.description }}</p>
                    {% endif %}
                    <p style="font-size: 0.875rem; color: var(--text-secondary);">
                        <i class="fas fa-ticket-alt"></i>
                        {{ ticket_type.remaining_tickets }} remaining
                    </p>
                </div>
                {% endfor %}
                
                <a href="{% url 'payments:checkout' event.id %}" class="btn-book">
                    <i class="fas fa-shopping-cart"></i>
                    Book Now
                </a>
            {% else %}
                <p class="text-center" style="color: var(--text-secondary);">
                    Tickets not yet available
                </p>
            {% endif %}
            
            <!-- Favorite Button -->
            <!-- Favorite Button -->
<button 
    class="favorite-btn active"
    onclick="toggleFavorite('{{ event.id }}')"
    id="favoriteBtn"
>
    <i class="fas fa-heart"></i>
</button>

<button class="book-ticket-btn" onclick="openTicketModal()">
    <i class="fas fa-ticket-alt"></i> Book Ticket
</button>






            <!-- Share Buttons -->
            <div class="mt-3">
                <p style="font-weight: 600; margin-bottom: 0.5rem;">Share this event:</p>
                <div class="d-flex gap-2">
                    <button class="btn btn-sm netflix-share-btn facebook">

                        <i class="fab fa-facebook-f"></i>
                    </button>
                    <button class="btn btn-sm netflix-share-btn twitter">
                        <i class="fab fa-twitter"></i>
                    </button>
                    <button class="btn btn-sm" style="background: #25D366; color: white;">
                        <i class="fab fa-whatsapp"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>



<!-- Ticket Booking Modal -->
<div class="ticket-modal-overlay" id="ticketModal">
    <div class="ticket-modal">
        <button class="close-modal" onclick="closeTicketModal()">&times;</button>

        <h4 class="modal-title">Book Tickets</h4>
        <p class="modal-event-title">{{ event.title }}</p>

        <div class="ticket-controls">
            <label>Number of Tickets</label>
            <div class="ticket-quantity">
                <button onclick="decreaseQty()">‚àí</button>
                <input type="number" id="ticketQty" value="1" min="1">
                <button onclick="increaseQty()">+</button>
            </div>
        </div>

        <div class="ticket-summary">
            <p>Price per ticket: <strong>${{ event.price }}</strong></p>
            <p>Total: <strong>$<span id="totalPrice">{{ event.price }}</span></strong></p>
        </div>

        <button class="confirm-booking-btn">
            Confirm Booking
        </button>
    </div>
</div>


<!-- Similar Events -->
{% if similar_events %}
<div class="mt-5">
    <h2 class="section-title">Similar Events</h2>
    <div class="events-grid">
        {% for similar_event in similar_events %}
        <a href="{% url 'events:detail' similar_event.slug %}" class="event-card">
            <div class="event-image-container">
                <img src="{{ similar_event.featured_image.url }}" alt="{{ similar_event.title }}" class="event-image">
                <span class="event-category-badge">{{ similar_event.category.get_name_display }}</span>
            </div>
            <div class="event-content">
                <span class="event-price">
                    {% if similar_event.is_free %}FREE{% else %}UGX {{ similar_event.base_price|floatformat:0 }}{% endif %}
                </span>
                <h3 class="event-title">{{ similar_event.title }}</h3>
                <div class="event-meta">
                    <div class="event-meta-item">
                        <i class="fas fa-calendar"></i>
                        <span>{{ similar_event.start_date|date:"M d" }}</span>
                    </div>
                </div>
            </div>
        </a>
        {% endfor %}
    </div>
</div>
{% endif %}

<script>
function toggleFavorite(eventId) {
    fetch(`/events/favorite/toggle/${eventId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'X-Requested-With': 'XMLHttpRequest',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        }
    })
    .catch(error => console.error('Error:', error));
}
</script>
{% endblock %}